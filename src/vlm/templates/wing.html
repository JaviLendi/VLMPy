{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="form-section">
        <h2>Plane Definition</h2>
        <form id="wing-form" aria-label="Plane Definition Form">
            <!-- Flight Condition -->
            <section class="form-group">
                <h3>Flight Condition</h3>
                {% for field in [
                    {"label": "Flight Velocity (m/s):", "id": "flight-velocity", "name": "u", "value": default_parameters.u, "step": "any"},
                    {"label": "Air Density (kg/mÂ³):", "id": "air-density", "name": "rho", "value": default_parameters.rho, "step": "0.001"},
                    {"label": "Angle of Attack (degrees):", "id": "angle-of-attack", "name": "alpha", "value": default_parameters.alpha, "step": "0.1"},
                    {"label": "Side Slip Angle (degrees):", "id": "side-slip-angle", "name": "beta", "value": default_parameters.beta, "step": "0.1"}
                ] %}
                <div class="input-group">
                    <label for="{{ field.id }}">{{ field.label }}</label>
                    <input type="number" id="{{ field.id }}" name="{{ field.name }}" value="{{ field.value }}" step="{{ field.step }}" required aria-required="true">
                </div>
                {% endfor %}
            </section>

            <!-- Wing Geometry -->
            <section class="form-group">
                <h3>Wing Geometry</h3>
                <div id="sections" aria-live="polite"></div>
                <div class="button-group">
                    <button type="button" class="action-button" onclick="addSection()">Add Section</button>
                    <button type="button" class="action-button" onclick="removeSection()">Remove Section</button>
                </div>
            </section>

            <!-- Horizontal Stabilizer -->
            <section class="stabilizer-section">
                <h3>Horizontal Stabilizer</h3>
                <input type="hidden" name="horizontal_toggled[]" value="0">
                <button type="button" class="toggle-button" onclick="toggleSection('horizontal-stabilizer-section', '[aria-controls=horizontal-stabilizer-section]')" aria-expanded="false" aria-controls="horizontal-stabilizer-section">
                    Toggle Horizontal Stabilizer
                </button>
                <div id="horizontal-stabilizer-section" class="form-group" style="display: none;">
                    {% for field in [
                        {"label": "X Translate (m):", "id": "horizontal-stabilizer-x-translate", "name": "x_translate", "type": "number", "value": default_plane.horizontal_stabilizer.x_translate, "step": "any"},
                        {"label": "Z Translate (m):", "id": "horizontal-stabilizer-z-translate", "name": "z_translate", "type": "number", "value": default_plane.horizontal_stabilizer.z_translate, "step": "any"},
                        {"label": "NACA Root:", "id": "horizontal-stabilizer-naca-root", "name": "NACA_root", "type": "text", "value": default_plane.horizontal_stabilizer.NACA_root},
                        {"label": "NACA Tip:", "id": "horizontal-stabilizer-naca-tip", "name": "NACA_tip", "type": "text", "value": default_plane.horizontal_stabilizer.NACA_tip},
                        {"label": "Chord Root (m):", "id": "horizontal-stabilizer-chord-root", "name": "chord_root", "type": "number", "value": default_plane.horizontal_stabilizer.chord_root, "step": "any"},
                        {"label": "Chord Tip (m):", "id": "horizontal-stabilizer-chord-tip", "name": "chord_tip", "type": "number", "value": default_plane.horizontal_stabilizer.chord_tip, "step": "any"},
                        {"label": "Span Fraction:", "id": "horizontal-stabilizer-span-fraction", "name": "span_fraction", "type": "number", "value": default_plane.horizontal_stabilizer.span_fraction, "step": "any"},
                        {"label": "Sweep (degrees):", "id": "horizontal-stabilizer-sweep", "name": "sweep", "type": "number", "value": default_plane.horizontal_stabilizer.sweep, "step": "any"},
                        {"label": "Dihedral (degrees):", "id": "horizontal-stabilizer-dihedral", "name": "htp_dihedral", "type": "number", "value": default_plane.horizontal_stabilizer.dihedral, "step": "any"},
                        {"label": "Alpha (degrees):", "id": "horizontal-stabilizer-alpha", "name": "htp_alpha", "type": "number", "value": default_plane.horizontal_stabilizer.alpha, "step": "any"}
                    ] %}
                    <div class="input-group">
                        <label for="{{ field.id }}">{{ field.label }}</label>
                        <input type="{{ field.type }}" id="{{ field.id }}" name="{{ field.name }}" value="{{ field.value }}" {% if field.step %}step="{{ field.step }}"{% endif %}>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Vertical Stabilizer -->
            <section class="stabilizer-section">
                <h3>Vertical Stabilizer</h3>
                <input type="hidden" name="vertical_toggled[]" value="0">
                <button type="button" class="toggle-button" onclick="toggleSection('vertical-stabilizer-section', '[aria-controls=vertical-stabilizer-section]')" aria-expanded="false" aria-controls="vertical-stabilizer-section">
                    Toggle Vertical Stabilizer
                </button>
                <div id="vertical-stabilizer-section" class="form-group" style="display: none;">
                    {% for field in [
                        {"label": "X Translate (m):", "id": "vertical-stabilizer-x-translate", "name": "x_translate_v", "type": "number", "value": default_plane.vertical_stabilizer.x_translate, "step": "any"},
                        {"label": "Z Translate (m):", "id": "vertical-stabilizer-z-translate", "name": "z_translate_v", "type": "number", "value": default_plane.vertical_stabilizer.z_translate, "step": "any"},
                        {"label": "NACA Root:", "id": "vertical-stabilizer-naca-root", "name": "NACA_root_v", "type": "text", "value": default_plane.vertical_stabilizer.NACA_root},
                        {"label": "NACA Tip:", "id": "vertical-stabilizer-naca-tip", "name": "NACA_tip_v", "type": "text", "value": default_plane.vertical_stabilizer.NACA_tip},
                        {"label": "Chord Root (m):", "id": "vertical-stabilizer-chord-root", "name": "chord_root_v", "type": "number", "value": default_plane.vertical_stabilizer.chord_root, "step": "any"},
                        {"label": "Chord Tip (m):", "id": "vertical-stabilizer-chord-tip", "name": "chord_tip_v", "type": "number", "value": default_plane.vertical_stabilizer.chord_tip, "step": "any"},
                        {"label": "Span Fraction:", "id": "vertical-stabilizer-span-fraction", "name": "span_fraction_v", "type": "number", "value": default_plane.vertical_stabilizer.span_fraction, "step": "any"},
                        {"label": "Sweep (degrees):", "id": "vertical-stabilizer-sweep", "name": "sweep_v", "type": "number", "value": default_plane.vertical_stabilizer.sweep, "step": "any"},
                        {"label": "Alpha (degrees):", "id": "vertical-stabilizer-alpha", "name": "alpha_v", "type": "number", "value": default_plane.vertical_stabilizer.alpha, "step": "any"}
                    ] %}
                    <div class="input-group">
                        <label for="{{ field.id }}">{{ field.label }}</label>
                        <input type="{{ field.type }}" id="{{ field.id }}" name="{{ field.name }}" value="{{ field.value }}" {% if field.step %}step="{{ field.step }}"{% endif %}>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Discretization -->
            <section class="form-group">
                <h3>Discretization</h3>
                <div class="input-group">
                    <label for="panels-span">Panels Along Span:</label>
                    <input type="number" id="panels-span" name="n" value="{{ default_parameters.n }}" required aria-required="true">
                </div>
                <div class="input-group">
                    <label for="panels-chord">Panels Along Chord:</label>
                    <input type="number" id="panels-chord" name="m" value="{{ default_parameters.m }}" required aria-required="true">
                </div>
            </section>

            <!-- Form Actions -->
            <div class="buttons">
                <button type="button" class="action-button" id="calculate-button" onclick="Calculate()">Calculate</button>
                <button type="button" class="action-button" id="view-planform-button" onclick="plotData('/plot/geometry_2d', 'Wing_Geometry_2d')">Planform</button>
                <button type="button" class="action-button" onclick="plotData('/plot/discretization2D', 'Wing_Discretization2d')">Discretization 2D</button>
                <button type="button" class="action-button" onclick="plotData('/plot/geometry', 'Wing_Geometry')">Geometry 3D</button>
                <button type="button" class="action-button" onclick="plotData('/plot/discretization3D', 'Wing_Discretization3d')">Discretization 3D</button>
            </div>
            <div class="buttons">
                <button type="button" class="action-button" onclick="savePlaneAdvanced()">Save</button>
                <button type="button" class="action-button" onclick="loadPlaneAdvanced()">Load</button>
                <button type="button" class="action-button" onclick="erasePlot()">Erase Plot</button>
                <input type="file" id="file-input" accept=".json" style="display: none;" onchange="loadData(this)">
            </div>
        </form>
    </div>
    <div id="plot-area" aria-live="polite"></div>
</div>

<script>

// Pass default plane from Flask to JavaScript
const defaultPlane = {{ default_plane | tojson }};

function plotData(endpoint, filename) {
    const form = document.getElementById("wing-form");
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: getFormDataAsJson("wing-form")
    })
    .then(response => response.json())
    .then(data => {
        if (data.plot) {
            // Remove the specific message from plot-area if present
            const plotArea = document.getElementById('plot-area');
            const unwantedMsg = plotArea.querySelector('p[style*="New plane configuration loaded"]');
            if (unwantedMsg) {
                unwantedMsg.remove();
            }
            Plotly.newPlot("plot-area", JSON.parse(data.plot));
        } else {
            console.error("No plot data received");
        }
    })
    .catch(error => console.error("Error generating plot:", error));
}

// Read file as text
const readFileAsText = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = () => reject(reader.error);
    reader.readAsText(file);
});

function loadData(input) {
    const file = input.files[0];
    if (!file) return window.messageCenter.error("No file selected.");
    if (!file.name.endsWith('.json')) return window.messageCenter.error("Please select a JSON file.");
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const config = JSON.parse(e.target.result);
            if (typeof populateFormWithConfig === 'function') {
                if (populateFormWithConfig(config)) {
                    window.messageCenter.success('New plane configuration loaded - previous results cleared.');
                    document.getElementById('plot-area').innerHTML = '<p style="color:#666;text-align:center;padding:20px;">New config loaded. Previous results cleared.</p>';
                } else {
                    window.messageCenter.error('Error populating form with configuration data.');
                }
            } else {
                fetch('/loadplane', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                })
                .then(r => r.ok ? r.json() : r.json().then(e => { throw new Error(e.message); }))
                .then(d => {
                    if (d.status === 'success' && d.plane && typeof populateFormWithConfig === 'function') {
                        populateFormWithConfig(d.plane);
                        window.messageCenter.success('New plane configuration loaded - previous results cleared.');
                        document.getElementById('plot-area').innerHTML = '<p style="color:#666;text-align:center;padding:20px;">Config loaded. Click "Calculate" for new results.</p>';
                    } else throw new Error(d.message || 'No plane data returned');
                })
                .catch(e => window.messageCenter.error(`Error loading plane: ${e.message}`));
            }
        } catch {
            window.messageCenter.error('Error: Invalid JSON file.');
        }
    };
    reader.onerror = () => window.messageCenter.error('Error: Unable to read file.');
    reader.readAsText(file);
}

function erasePlot() {
    Plotly.purge("plot-area");
    document.getElementById('plot-area').innerHTML = '<p style="color:#666;text-align:center;padding:20px;">Plot area cleared. Click "Calculate" to generate new results.</p>';
}

const radToDeg = r => (r == null ? r : r * 57.29577951308232);

function convertAngleIfNeeded(value, isAngle = false) {
    if (!isAngle || value == null) return value;
    return Math.abs(value) <= 6.28 ? radToDeg(value) : value;
}

 // ===== MAIN FUNCTION WITH ANGLE CONVERSION =====
function populateFormWithConfig(config) {
    try {
        // === FLIGHT PARAMETERS ===
        [
            { id: 'flight-velocity', val: config.flight_parameters?.u },
            { id: 'air-density', val: config.flight_parameters?.rho },
            { id: 'angle-of-attack', val: convertAngleIfNeeded(config.flight_parameters?.alpha, true) },
            { id: 'side-slip-angle', val: convertAngleIfNeeded(config.flight_parameters?.beta, true) }
        ].forEach(({ id, val }) => {
            const el = document.getElementById(id);
            if (el && val != null) el.value = val;
        });

        // === DISCRETIZATION ===
        [
            { id: 'panels-span', val: config.flight_parameters?.n },
            { id: 'panels-chord', val: config.flight_parameters?.m }
        ].forEach(({ id, val }) => {
            const el = document.getElementById(id);
            if (el && val != null) el.value = val;
        });

        // === WING SECTIONS ===
        const wingSections = config.wing_sections;
        if (Array.isArray(wingSections) && wingSections.length) {
            const container = document.getElementById('sections');
            if (container) container.innerHTML = '';
            for (let i = 0; i < wingSections.length; i++) {
                if (typeof addSection === 'function') addSection();
                else return false;
            }
            setTimeout(() => populateSectionsDataWithAngles(wingSections), 200);
        }

        // === STABILIZERS ===
        const hsData = config.horizontal_stabilizer;
        if (hsData) {
            const hsSection = document.getElementById('horizontal-stabilizer-section');
            if (hsSection && hsSection.style.display === 'none')
                toggleSection('horizontal-stabilizer-section', '[aria-controls="horizontal-stabilizer-section"]');
            setTimeout(() => populateHorizontalStabilizerDataWithAngles(hsData), 250);
        }
        else { // Ensure section is hidden if no data
            const hsSection = document.getElementById('horizontal-stabilizer-section');
            if (hsSection && hsSection.style.display !== 'none')
                toggleSection('horizontal-stabilizer-section', '[aria-controls="horizontal-stabilizer-section"]');
        }

        const vsData = config.vertical_stabilizer;
        if (vsData) {
            const vsSection = document.getElementById('vertical-stabilizer-section');
            if (vsSection && vsSection.style.display === 'none')
                toggleSection('vertical-stabilizer-section', '[aria-controls="vertical-stabilizer-section"]');
            setTimeout(() => populateVerticalStabilizerDataWithAngles(vsData), 300);
        }
        else { // Ensure section is hidden if no data
            const vsSection = document.getElementById('vertical-stabilizer-section');
            if (vsSection && vsSection.style.display !== 'none')
                toggleSection('vertical-stabilizer-section', '[aria-controls="vertical-stabilizer-section"]');
        }

        return true;
    } catch (error) {
        console.error("Error populating form:", error);
        return false;
    }
}

// ===== AUXILIAR FUNCTION FOR WING SECTIONS WITH ANGLE CONVERSION =====
function populateSectionsDataWithAngles(wingSections) {
    const sectionsContainer = document.getElementById('sections');
    if (!sectionsContainer) return console.error("â Sections container not found");

    const sectionDivs = sectionsContainer.children;
    wingSections.forEach((section, idx) => {
        const sectionDiv = sectionDivs[idx];
        if (!sectionDiv) return;

        // Main Section Fields
        [
            ['chord_root[]', section.chord_root ?? section.chordroot],
            ['chord_tip[]', section.chord_tip ?? section.chordtip],
            ['span_fraction[]', section.span_fraction ?? section.spanfraction],
            ['sweep[]', convertAngleIfNeeded(section.sweep, true)],
            ['dihedral[]', convertAngleIfNeeded(section.dihedral, true)],
            ['naca_root[]', section.NACA_root ?? section.NACAroot ?? section.naca_root],
            ['naca_tip[]', section.NACA_tip ?? section.NACAtip ?? section.naca_tip]
        ].forEach(([name, value]) => {
            const input = sectionDiv.querySelector(`input[name="${name}"]`);
            if (input && value != null) input.value = value;
        });

        // Flap
        const flapStart = section.flap_start ?? section.flapstart;
        if (flapStart != null) {
            const sectionNumber = idx + 1;
            const flapToggleButton = sectionDiv.querySelector(`#aileron-${sectionNumber}`);
            const flapParams = sectionDiv.querySelector('.flap-params');
            if (flapToggleButton && flapParams && flapParams.style.display === 'none') toggleFlap(flapToggleButton);

            setTimeout(() => {
                [
                    ['flap_start[]', section.flap_start ?? section.flapstart],
                    ['flap_end[]', section.flap_end ?? section.flapend],
                    ['flap_hinge_chord[]', section.flap_hinge_chord ?? section.flaphingechord],
                    ['deflection_angle[]', convertAngleIfNeeded(section.deflection_angle ?? section.deflectionangle, true)],
                    ['deflection_type[]', section.deflection_type ?? section.deflectiontype]
                ].forEach(([name, value]) => {
                    let input = flapParams?.querySelector(`input[name="${name}"]`) || flapParams?.querySelector(`select[name="${name}"]`);
                    if (input && value != null) input.value = value;
                });
            }, 100);
        }
    });
}

// ===== STABILIZER POPULATION WITH ANGLE CONVERSION =====
function populateStabilizerDataWithAngles(data, prefix, fields) {
    fields.forEach(([suffix, key, isAngle]) => {
        const id = `${prefix}-${suffix}`;
        let value = data[key];
        if (isAngle) value = convertAngleIfNeeded(value, true);
        const element = document.getElementById(id);
        if (element && value != null) element.value = value;
    });
}

function populateHorizontalStabilizerDataWithAngles(hsData) {
    populateStabilizerDataWithAngles(hsData, 'horizontal-stabilizer', [
        ['x-translate', 'x_translate', false],
        ['z-translate', 'z_translate', false],
        ['naca-root', 'NACA_root', false],
        ['naca-tip', 'NACA_tip', false],
        ['chord-root', 'chord_root', false],
        ['chord-tip', 'chord_tip', false],
        ['span-fraction', 'span_fraction', false],
        ['sweep', 'sweep', true],
        ['alpha', 'alpha', true],
        ['dihedral', 'dihedral', true]
    ]);
}

function populateVerticalStabilizerDataWithAngles(vsData) {
    populateStabilizerDataWithAngles(vsData, 'vertical-stabilizer', [
        ['x-translate', 'x_translate', false],
        ['z-translate', 'z_translate', false],
        ['naca-root', 'NACA_root', false],
        ['naca-tip', 'NACA_tip', false],
        ['chord-root', 'chord_root', false],
        ['chord-tip', 'chord_tip', false],
        ['span-fraction', 'span_fraction', false],
        ['sweep', 'sweep', true],
        ['alpha', 'alpha', true],
        ['dihedral', 'dihedral', true]
    ]);
}

// Optimize Enter key event to trigger Calculate and Planform only if focused in form
document.getElementById('wing-form').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('calculate-button')?.click();
        document.getElementById('view-planform-button')?.click();
    }
});

// DOM initialization and default plane population
document.addEventListener('DOMContentLoaded', () => {
    if (window.defaultPlane) {
        populateFormWithConfig(window.defaultPlane);
    }
});
</script>
{% endblock %}